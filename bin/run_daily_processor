#!/usr/bin/perl
#
#  Script to run a daily processor.  This just creates and runs a LINZ::GNSS::DailyProcessor 
#  instance using the specified configuration
#

use strict;
use LINZ::GNSS::DailyProcessor;
use Getopt::Std;

my %opts;
getopts('c',\%opts);

if( $opts{c} )
{
    print LINZ::GNSS::DailyProcessor::ExampleConfig;
    exit();
}

@ARGV || die <<EOD;

syntax: run_daily_processor [options] configuration_file [option=value option=value ...]

Options can include
   -c      Just print an example configuration file and exit

EOD

my $configfile=shift @ARGV;
my @params=@ARGV;

eval
{
    die "$configfile is missing\n" if ! -e $configfile;
    my $processor=new LINZ::GNSS::DailyProcessor($configfile,@params);
    $processor->runProcessor( sub {
        my $prescripts=$processor->get('prerun_script');
        my $ok=1;
        $ok=$processor->runScripts($prescripts) if $prescripts !~ /^\s*none\s*$/i;
        return $ok if ! $ok;
        $processor->runBernesePcf() if $processor->get('pcf');
        my $postscripts=$processor->get('postrun_script');
        $ok=$processor->runScripts($postscripts) if $postscripts !~ /^\s*none\s*$/i;
        return $ok;
        });
};
if( $@ )
{
    print "Processing failed: $@\n";
}
